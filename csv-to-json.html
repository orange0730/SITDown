<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV è½‰ JSON å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4ecdc4;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        button {
            background: #4ecdc4;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #3cbab2;
        }
        textarea {
            width: 100%;
            height: 400px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
        }
        .stats {
            margin: 20px 0;
            padding: 15px;
            background: rgba(78, 205, 196, 0.2);
            border-radius: 5px;
        }
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .tag {
            background: rgba(78, 205, 196, 0.3);
            padding: 5px 15px;
            border-radius: 15px;
            border: 1px solid rgba(78, 205, 196, 0.6);
        }
        .upload-area {
            border: 2px dashed #4ecdc4;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: rgba(78, 205, 196, 0.1);
            cursor: pointer;
        }
        .upload-area:hover {
            background: rgba(78, 205, 196, 0.2);
        }
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <h1>ğŸ“„ CSV è½‰ JSON å·¥å…·</h1>
    
    <div class="section">
        <h2>1. ä¸Šå‚³ CSV æª”æ¡ˆ</h2>
        <div class="upload-area" id="uploadArea">
            <p>ğŸ“ é»æ“Šä¸Šå‚³æˆ–æ‹–æ‹½ CSV æª”æ¡ˆåˆ°é€™è£¡</p>
            <input type="file" id="fileInput" accept=".csv">
        </div>
    </div>
    
    <div class="section" id="tagsSection" style="display: none;">
        <h2>2. ç™¼ç¾çš„æ¨™ç±¤</h2>
        <div id="discoveredTags" class="tag-list"></div>
    </div>
    
    <div class="section">
        <h2>3. çµ±è¨ˆè³‡è¨Š</h2>
        <div id="stats" class="stats"></div>
    </div>
    
    <div class="section">
        <h2>4. JSON è¼¸å‡º</h2>
        <textarea id="jsonOutput" readonly placeholder="JSON æœƒé¡¯ç¤ºåœ¨é€™è£¡..."></textarea>
        <button onclick="copyJSON()">ğŸ“‹ è¤‡è£½ JSON</button>
        <button onclick="downloadJSON()">ğŸ’¾ ä¸‹è¼‰ JSON</button>
        <button onclick="saveToLocalStorage()">ğŸ“± å„²å­˜åˆ° LocalStorage</button>
    </div>
    
    <script>
        let processedData = [];
        let collectedTags = new Set();
        let errorLog = [];
        
        // ä¸Šå‚³å€åŸŸäº‹ä»¶
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.background = 'rgba(78, 205, 196, 0.3)';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.background = 'rgba(78, 205, 196, 0.1)';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.background = 'rgba(78, 205, 196, 0.1)';
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.csv')) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                processCSV(e.target.result);
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        function processCSV(content) {
            const lines = content.split('\n').filter(line => line.trim());
            processedData = [];
            collectedTags.clear();
            errorLog = [];
            
            let validCount = 0;
            let invalidCount = 0;
            let tagUsage = {};
            
            // è·³éæ¨™é¡Œè¡Œï¼Œå¾ç¬¬äºŒè¡Œé–‹å§‹
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const columns = parseCSVRow(line);
                
                if (columns.length < 2) {
                    errorLog.push({
                        line: i + 1,
                        reason: 'æ¬„ä½ä¸è¶³ï¼ˆéœ€è¦è‡³å°‘ 2 æ¬„ï¼šæ¨™ç±¤, URLï¼‰',
                        content: line.substring(0, 100) + (line.length > 100 ? '...' : '')
                    });
                    invalidCount++;
                    continue;
                }
                
                const tagsStr = columns[0] ? columns[0].trim() : '';
                const url = columns[1] ? columns[1].trim() : '';
                
                // æª¢æŸ¥å„ç¨®éŒ¯èª¤æƒ…æ³
                if (!tagsStr) {
                    errorLog.push({
                        line: i + 1,
                        reason: 'æ²’æœ‰æ¨™ç±¤',
                        content: `URL: ${url}`
                    });
                    invalidCount++;
                    continue;
                }
                
                if (!url) {
                    errorLog.push({
                        line: i + 1,
                        reason: 'æ²’æœ‰ URL',
                        content: `æ¨™ç±¤: ${tagsStr}`
                    });
                    invalidCount++;
                    continue;
                }
                
                if (!isValidUrl(url)) {
                    errorLog.push({
                        line: i + 1,
                        reason: 'ç„¡æ•ˆçš„ URLï¼ˆå¿…é ˆæ˜¯ YouTube æˆ– .mp4/.webm æª”æ¡ˆï¼‰',
                        content: `URL: ${url}`
                    });
                    invalidCount++;
                    continue;
                }
                
                // è§£ææ¨™ç±¤
                const tagList = tagsStr.split(/[,ï¼Œ\/ã€]/)
                    .map(tag => tag.trim())
                    .filter(tag => tag.length > 0);
                
                if (tagList.length === 0) {
                    errorLog.push({
                        line: i + 1,
                        reason: 'æ¨™ç±¤è§£æå¾Œç‚ºç©º',
                        content: `åŸå§‹æ¨™ç±¤: ${tagsStr}`
                    });
                    invalidCount++;
                    continue;
                }
                
                // æˆåŠŸè™•ç†
                const video = {
                    id: processedData.length + 1,
                    title: generateTitle(tagList[0]),
                    url: convertToEmbedUrl(url),
                    tags: tagList,
                    type: detectVideoType(url)
                };
                
                processedData.push(video);
                validCount++;
                
                // æ”¶é›†æ‰€æœ‰æ¨™ç±¤ä¸¦çµ±è¨ˆä½¿ç”¨æ¬¡æ•¸
                tagList.forEach(tag => {
                    collectedTags.add(tag);
                    tagUsage[tag] = (tagUsage[tag] || 0) + 1;
                });
            }
            
            // é¡¯ç¤ºæ”¶é›†åˆ°çš„æ¨™ç±¤
            displayCollectedTags();
            
            // é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
            displayStats(validCount, invalidCount, tagUsage);
            
            // é¡¯ç¤º JSON
            displayJSON();
        }
        
        function displayCollectedTags() {
            const tagsSection = document.getElementById('tagsSection');
            const container = document.getElementById('discoveredTags');
            
            if (collectedTags.size > 0) {
                tagsSection.style.display = 'block';
                container.innerHTML = Array.from(collectedTags)
                    .sort()
                    .map(tag => `<span class="tag">${tag}</span>`)
                    .join('');
            } else {
                tagsSection.style.display = 'none';
            }
        }
        
        function isValidUrl(url) {
            return url.includes('youtube') || 
                   url.includes('youtu.be') || 
                   url.endsWith('.mp4') ||
                   url.endsWith('.webm');
        }
        
        function detectVideoType(url) {
            if (url.includes('youtube') || url.includes('youtu.be')) {
                return 'youtube';
            }
            return 'direct';
        }
        
        function convertToEmbedUrl(url) {
            if (url.includes('youtube.com/shorts/')) {
                const match = url.match(/shorts\/([a-zA-Z0-9_-]+)/);
                if (match) return `https://www.youtube.com/embed/${match[1]}`;
            } else if (url.includes('youtu.be/')) {
                const match = url.match(/youtu\.be\/([a-zA-Z0-9_-]+)/);
                if (match) return `https://www.youtube.com/embed/${match[1]}`;
            } else if (url.includes('youtube.com/watch')) {
                const match = url.match(/[?&]v=([a-zA-Z0-9_-]+)/);
                if (match) return `https://www.youtube.com/embed/${match[1]}`;
            }
            return url;
        }
        
        function generateTitle(tag) {
            const templates = {
                'å¨›æ¨‚æç¬‘': ['æç¬‘ç¬é–“', 'çˆ†ç¬‘æ™‚åˆ»', 'æœ‰è¶£ç‰‡æ®µ'],
                'éŠæˆ²': ['éŠæˆ²ç²¾å½©æ™‚åˆ»', 'éŠæˆ²æŠ€å·§', 'éŠæˆ²äº®é»'],
                'è—è¡“': ['è—è¡“å‰µä½œ', 'å‰µæ„ä½œå“', 'è—è¡“å±•ç¤º'],
                'é›»å½±': ['é›»å½±ç‰‡æ®µ', 'å½±è¦–ç²¾é¸', 'ç¶“å…¸å ´é¢'],
                'æ—¥å¸¸': ['ç”Ÿæ´»æ—¥å¸¸', 'æ—¥å¸¸ç´€éŒ„', 'ç”Ÿæ´»ç‰‡æ®µ'],
                'å‹•ç‰©': ['å¯æ„›å‹•ç‰©', 'å‹•ç‰©è¶£äº‹', 'èŒå¯µæ™‚åˆ»'],
                'ç™‚æ„ˆ': ['ç™‚ç™’æ™‚å…‰', 'æ”¾é¬†ç‰‡æ®µ', 'æ²»ç™’ç¬é–“'],
                'éŸ³æ¨‚èˆè¹ˆ': ['éŸ³æ¨‚è¡¨æ¼”', 'èˆè¹ˆå±•ç¤º', 'è—è¡“è¡¨æ¼”'],
                'æ™‚å°š': ['æ™‚å°šç©¿æ­', 'ç¾å¦æŠ€å·§', 'é¢¨æ ¼å±•ç¤º'],
                'æ•™å­¸': ['å¯¦ç”¨æ•™å­¸', 'æŠ€å·§åˆ†äº«', 'å­¸ç¿’æ™‚åˆ»'],
                'æŒ‘æˆ°': ['æœ‰è¶£æŒ‘æˆ°', 'å‰µæ„æŒ‘æˆ°', 'æŠ€èƒ½æŒ‘æˆ°'],
                'å¯¦é©—å‰µæ„': ['å‰µæ„å¯¦é©—', 'ç§‘å­¸å¯¦é©—', 'å‰µæ–°æƒ³æ³•'],
                'é‹å‹•': ['é‹å‹•ç²¾å½©', 'å¥èº«æŠ€å·§', 'é‹å‹•ç¬é–“'],
                'åäºº': ['åäººæ™‚åˆ»', 'æ˜æ˜Ÿç‰‡æ®µ', 'äººç‰©å°ˆè¨ª'],
                'ç§‘æŠ€': ['ç§‘æŠ€æ–°çŸ¥', 'æŠ€è¡“å±•ç¤º', 'å‰µæ–°ç§‘æŠ€'],
                'æ—…éŠ': ['æ—…éŠæ™¯é»', 'æ—…è¡Œåˆ†äº«', 'é¢¨æ™¯æ¬£è³'],
                'å‹µå¿—': ['å‹µå¿—æ•…äº‹', 'æ­£èƒ½é‡æ™‚åˆ»', 'æ¿€å‹µäººå¿ƒ'],
                'æƒ¡æ•´': ['æƒ¡æ•´æ™‚åˆ»', 'æ•´äººç²¾é¸', 'æƒ¡ä½œåŠ‡é›†éŒ¦'],
                'é£Ÿç‰©': ['ç¾é£Ÿåˆ†äº«', 'æ–™ç†æ•™å­¸', 'é£Ÿç‰©æ¢ç´¢']
            };
            
            const defaultTemplates = ['ç²¾å½©å½±ç‰‡', 'æ¨è–¦è§€çœ‹', 'å€¼å¾—ä¸€çœ‹'];
            const selectedTemplates = templates[tag] || defaultTemplates;
            return selectedTemplates[Math.floor(Math.random() * selectedTemplates.length)];
        }
        
        function displayStats(validCount, invalidCount, tagUsage) {
            const statsDiv = document.getElementById('stats');
            
            let html = `
                <p>âœ… æˆåŠŸè™•ç†ï¼š${validCount} å€‹å½±ç‰‡</p>
                <p>âŒ è·³éï¼š${invalidCount} å€‹é …ç›®ï¼ˆç„¡æ•ˆ URL æˆ–ç„¡æ¨™ç±¤ï¼‰</p>
                <p>ğŸ·ï¸ ç¸½å…±ç™¼ç¾ï¼š${collectedTags.size} å€‹ä¸åŒæ¨™ç±¤</p>
                <p>ğŸ“Š æ¨™ç±¤ä½¿ç”¨çµ±è¨ˆï¼š</p>
                <ul>
            `;
            
            // æ’åºä¸¦é¡¯ç¤ºæ¨™ç±¤ä½¿ç”¨æƒ…æ³
            Object.entries(tagUsage)
                .sort((a, b) => b[1] - a[1])
                .forEach(([tag, count]) => {
                    html += `<li>${tag}: ${count} æ¬¡</li>`;
                });
            
            html += '</ul>';
            
            // å¦‚æœæœ‰éŒ¯èª¤ï¼Œé¡¯ç¤ºéŒ¯èª¤è©³æƒ…
            if (errorLog.length > 0) {
                html += `
                    <details style="margin-top: 20px; cursor: pointer;">
                        <summary style="color: #ff6b6b; font-weight: bold;">
                            âš ï¸ æŸ¥çœ‹è¢«è·³éé …ç›®çš„è©³ç´°åŸå› ï¼ˆé»æ“Šå±•é–‹ï¼‰
                        </summary>
                        <div style="margin-top: 10px; max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
                `;
                
                // æŒ‰éŒ¯èª¤åŸå› åˆ†çµ„
                const errorsByReason = {};
                errorLog.forEach(error => {
                    if (!errorsByReason[error.reason]) {
                        errorsByReason[error.reason] = [];
                    }
                    errorsByReason[error.reason].push(error);
                });
                
                // é¡¯ç¤ºæ¯ç¨®éŒ¯èª¤é¡å‹
                Object.entries(errorsByReason).forEach(([reason, errors]) => {
                    html += `<p style="color: #ffa94d; margin-top: 10px;">ğŸ“Œ ${reason} (${errors.length} å€‹):</p>`;
                    html += '<ul style="font-size: 12px; color: #ccc;">';
                    errors.slice(0, 10).forEach(error => {
                        html += `<li>ç¬¬ ${error.line} è¡Œ: ${error.content}</li>`;
                    });
                    if (errors.length > 10) {
                        html += `<li>... é‚„æœ‰ ${errors.length - 10} å€‹é¡ä¼¼éŒ¯èª¤</li>`;
                    }
                    html += '</ul>';
                });
                
                html += `
                        </div>
                    </details>
                `;
            }
            
            statsDiv.innerHTML = html;
        }
        
        function displayJSON() {
            const jsonOutput = document.getElementById('jsonOutput');
            jsonOutput.value = JSON.stringify(processedData, null, 2);
        }
        
        function copyJSON() {
            const jsonOutput = document.getElementById('jsonOutput');
            jsonOutput.select();
            document.execCommand('copy');
            alert('JSON å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        }
        
        function downloadJSON() {
            const blob = new Blob([JSON.stringify(processedData, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'videos.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function saveToLocalStorage() {
            localStorage.setItem('sitdown_manual_videos', JSON.stringify(processedData));
            alert(`å·²å„²å­˜ ${processedData.length} å€‹å½±ç‰‡åˆ° LocalStorageï¼\nè«‹ç¢ºä¿ script.js ä¸­çš„ USE_BACKEND è¨­ç‚º false`);
        }
    </script>
</body>
</html> 